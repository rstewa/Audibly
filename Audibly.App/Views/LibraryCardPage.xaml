<?xml version="1.0" encoding="utf-8" ?>

<Page
    x:Class="Audibly.App.Views.LibraryCardPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:converters="using:Audibly.App.Helpers.Converters"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:userControls="using:Audibly.App.UserControls"
    xmlns:viewModels="using:Audibly.App.ViewModels"
    xmlns:views="using:Audibly.App.Views"
    xmlns:winUi="using:CommunityToolkit.WinUI"
    Background="Transparent"
    KeyboardAcceleratorPlacementMode="Hidden"
    mc:Ignorable="d">

    <Page.Resources>
        <converters:StringToImageSourceConverter x:Key="StringToImageSourceConverter" />
        <DataTemplate x:Key="AudiobookTemplate" x:DataType="viewModels:AudiobookViewModel">
            <userControls:AudiobookTile
                Title="{x:Bind Title, Mode=OneWay}"
                Author="{x:Bind Author, Mode=OneWay}"
                FilePath="{x:Bind CurrentSourceFile.FilePath, Mode=OneWay}"
                Id="{x:Bind Id, Mode=OneWay}"
                IsCompleted="{x:Bind IsCompleted, Mode=OneWay}"
                Progress="{x:Bind Progress, Mode=OneWay}"
                SourcePaths="{x:Bind SourcePaths, Mode=OneWay}"
                SourcePathsCount="{x:Bind SourcePaths.Count, Mode=OneWay}">
                <userControls:AudiobookTile.Source>
                    <Image Source="{x:Bind ThumbnailPath, Mode=OneWay, Converter={StaticResource StringToImageSourceConverter}}" Stretch="Uniform" />
                </userControls:AudiobookTile.Source>
            </userControls:AudiobookTile>
        </DataTemplate>
    </Page.Resources>

    <Page.KeyboardAccelerators>
        <KeyboardAccelerator
            Key="F12"
            Invoked="DebugMenuKeyboardAccelerator_OnInvoked"
            Modifiers="Control,Shift" />
    </Page.KeyboardAccelerators>

    <RelativePanel x:Name="LayoutRoot" Padding="36,36,48,0">
        <!--  start panel (shown when no audiobooks have been imported yet)  -->
        <StackPanel
            x:Name="StartPanel"
            Orientation="Vertical"
            RelativePanel.AlignHorizontalCenterWithPanel="True"
            RelativePanel.AlignVerticalCenterWithPanel="True"
            Visibility="{x:Bind ViewModel.ShowStartPanel, Mode=OneWay}">

            <TextBlock
                Margin="0,0,0,16"
                FontSize="36"
                Opacity="0.8"
                Style="{StaticResource TitleTextBlockStyle}"
                Text="Audibly"
                TextAlignment="Left" />

            <TextBlock
                Margin="0,0,0,8"
                FontSize="24"
                Opacity="0.6"
                Style="{StaticResource SubtitleTextBlockStyle}"
                Text="Start"
                TextAlignment="Left" />

            <userControls:CustomHyperlinkButton
                ButtonClick="{x:Bind ViewModel.ImportAudiobookAsync}"
                Icon="&#xE8E5;"
                Text="{x:Bind views:LibraryCardPage.ImportAudiobookText}" />

            <userControls:CustomHyperlinkButton
                ButtonClick="{x:Bind ViewModel.ImportAudiobooksFromDirectoryAsync}"
                Icon="&#xED25;"
                Text="{x:Bind views:LibraryCardPage.ImportAudiobooksFromDirectoryText}" />

            <userControls:CustomHyperlinkButton
                ButtonClick="{x:Bind ViewModel.ImportAudiobookWithMultipleFilesAsync}"
                Icon="&#xE838;"
                Text="{x:Bind views:LibraryCardPage.ImportAudiobookWithMultipleFilesText}" />

            <userControls:CustomHyperlinkButton
                ButtonClick="{x:Bind ViewModel.ImportFromUserSelectedJsonFileAsync}"
                Icon="&#xE896;"
                Text="{x:Bind views:LibraryCardPage.ImportFromJsonFileText}" />

        </StackPanel>

        <!--  title and command bar  -->
        <StackPanel
            x:Name="TitleAndCommandBarPanel"
            HorizontalAlignment="Left"
            Orientation="Vertical">
            <TextBlock
                x:Name="PageTitle"
                Margin="20,8,6,0"
                Style="{StaticResource PageTitleTextBlockStyle}"
                Text="Audiobook Library" />
            <StackPanel
                Margin="4,0,0,0"
                Orientation="Horizontal"
                RelativePanel.LeftOf="AudiobookSearchBox"
                RelativePanel.RightOf="PageTitle">

                <!--  TODO: tokenizing search box  -->
                <!--  <controls:TokenizingTextBox  -->
                <!--  PlaceholderText="Search audiobooks"  -->
                <!--  QueryIcon="Find"  -->
                <!--  QuerySubmitted="AudiobookSearchBox_OnQuerySubmitted"  -->
                <!--  x:Name="AudiobookSearchBox" />  -->

                <CommandBar
                    x:Name="MainCommandBar"
                    HorizontalAlignment="Left"
                    Background="Transparent"
                    DefaultLabelPosition="Right">
                    <AppBarButton
                        x:Name="FilterButton"
                        Icon="Filter"
                        Label="Filter"
                        ToolTipService.ToolTip="Filter Audiobooks">
                        <Button.Flyout>
                            <!--  create custom filter checkbox flyout  -->
                            <Flyout Placement="BottomEdgeAlignedLeft">
                                <StackPanel Orientation="Vertical">
                                    <CheckBox
                                        x:Name="SelectAllFiltersCheckBox"
                                        Checked="SelectAllFiltersCheckBox_OnChecked"
                                        Content="Select all"
                                        Indeterminate="SelectAllFiltersCheckBox_OnIndeterminate"
                                        IsThreeState="True"
                                        Unchecked="SelectAllFiltersCheckBox_OnUnchecked" />
                                    <CheckBox
                                        x:Name="InProgressFilterCheckBox"
                                        Margin="24,0,0,0"
                                        Checked="InProgressFilterCheckBox_OnChecked"
                                        Content="In Progress"
                                        Unchecked="InProgressFilterCheckBox_OnUnchecked" />
                                    <CheckBox
                                        x:Name="NotStartedFilterCheckBox"
                                        Margin="24,0,0,0"
                                        Checked="NotStartedFilterCheckBox_OnChecked"
                                        Content="Not Started"
                                        Unchecked="NotStartedFilterCheckBox_OnUnchecked" />
                                    <CheckBox
                                        x:Name="CompletedFilterCheckBox"
                                        Margin="24,0,0,0"
                                        Checked="CompletedFilterCheckBox_OnChecked"
                                        Content="Completed"
                                        Unchecked="CompletedFilterCheckBox_OnUnchecked" />
                                </StackPanel>
                            </Flyout>
                        </Button.Flyout>
                    </AppBarButton>
                    <AppBarButton
                        Click="{x:Bind RefreshButton_OnClick}"
                        Icon="Refresh"
                        Label="Refresh"
                        ToolTipService.ToolTip="Refresh audiobooks" />
                    <AppBarSeparator />
                    <AppBarButton
                        Icon="Download"
                        Label="Import"
                        ToolTipService.ToolTip="Import audiobooks">
                        <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE838;" />
                        <AppBarButton.Flyout>
                            <MenuFlyout Placement="BottomEdgeAlignedLeft">
                                <MenuFlyoutItem
                                    Click="{x:Bind ViewModel.ImportAudiobookAsync}"
                                    Icon="OpenFile"
                                    Text="{x:Bind views:LibraryCardPage.ImportAudiobookText}" />
                                <MenuFlyoutItem
                                    Click="{x:Bind ViewModel.ImportAudiobooksFromDirectoryAsync}"
                                    Icon="Folder"
                                    Text="{x:Bind views:LibraryCardPage.ImportAudiobooksFromDirectoryText}" />
                                <MenuFlyoutSeparator />
                                <MenuFlyoutItem Click="{x:Bind ViewModel.ImportAudiobookWithMultipleFilesAsync}" Text="{x:Bind views:LibraryCardPage.ImportAudiobookWithMultipleFilesText}">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon Glyph="&#xE838;" />
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                <MenuFlyoutSeparator />
                                <MenuFlyoutItem
                                    Click="{x:Bind ViewModel.ImportFromUserSelectedJsonFileAsync}"
                                    Icon="Download"
                                    Text="{x:Bind views:LibraryCardPage.ImportFromJsonFileText}" />
                            </MenuFlyout>
                        </AppBarButton.Flyout>
                    </AppBarButton>
                    <AppBarButton Label="Export" ToolTipService.ToolTip="Export audiobooks">
                        <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xEDE1;" />
                        <AppBarButton.Flyout>
                            <MenuFlyout Placement="BottomEdgeAlignedLeft">
                                <MenuFlyoutItem Click="{x:Bind ViewModel.CreateExportFile}" Text="Export audiobooks in library to JSON file for later import">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon Glyph="&#xEDE1;" />
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                            </MenuFlyout>
                        </AppBarButton.Flyout>
                    </AppBarButton>
                    <AppBarSeparator />

                    <!--  zoom drop down button  -->
                    <AppBarButton
                        x:Name="ZoomButton"
                        Icon="Zoom"
                        Label="Zoom"
                        ToolTipService.ToolTip="Zoom">
                        <AppBarButton.Flyout>
                            <Flyout x:Name="ZoomFlyout" Placement="BottomEdgeAlignedLeft">
                                <userControls:ZoomLevelUserControl
                                    x:Name="ZoomLevelUserControl"
                                    ZoomInButtonIsEnabled="{x:Bind ViewModel.ZoomInButtonIsEnabled, Mode=OneWay}"
                                    ZoomOutButtonIsEnabled="{x:Bind ViewModel.ZoomOutButtonIsEnabled, Mode=OneWay}" />
                            </Flyout>
                        </AppBarButton.Flyout>
                    </AppBarButton>

                    <!--  region: debug menu  -->
                    <AppBarSeparator x:Name="DebugMenuSeparator" Visibility="{x:Bind ViewModel.ShowDebugMenu, Mode=OneWay}" />

                    <AppBarButton
                        Label="Debug Menu"
                        ToolTipService.ToolTip="Debug Menu"
                        Visibility="{x:Bind ViewModel.ShowDebugMenu, Mode=OneWay}">
                        <AppBarButton.Flyout>
                            <MenuFlyout Placement="BottomEdgeAlignedLeft">
                                <ToggleMenuFlyoutItem
                                    Icon="AlignCenter"
                                    IsChecked="{x:Bind ViewModel.ShowAlignmentGrids, Mode=TwoWay}"
                                    Text="Show Alignment Grid"
                                    ToolTipService.ToolTip="Show Alignment Grid" />
                                <ToggleMenuFlyoutItem
                                    Icon="Refresh"
                                    IsChecked="{x:Bind ViewModel.IsLoading, Mode=TwoWay}"
                                    Text="Toggle Loading Progress Bar"
                                    ToolTipService.ToolTip="Toggle Loading Progress Bar" />
                                <MenuFlyoutItem
                                    Click="{x:Bind ViewModel.DeleteAudiobooksAsync}"
                                    Icon="Delete"
                                    Text="Delete All"
                                    ToolTipService.ToolTip="Delete all audiobooks" />
                                <MenuFlyoutItem
                                    Click="{x:Bind ViewModel.MigrateDatabase}"
                                    Icon="Sync"
                                    Text="Test Data Migration"
                                    ToolTipService.ToolTip="Test Data Migration" />
                                <MenuFlyoutItem
                                    Click="{x:Bind OpenAppStateFolderButton_OnClick}"
                                    Text="Open App State Folder"
                                    ToolTipService.ToolTip="Open App State Folder">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xED25;" />
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                <MenuFlyoutItem
                                    Click="{x:Bind OpenCurrentAudiobooksAppStateFolder_OnClick}"
                                    Text="Open Audiobook App State Folder"
                                    ToolTipService.ToolTip="Open Current Audiobooks App State Folder">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xED25;" />
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                <MenuFlyoutItem
                                    Click="{x:Bind TestContentDialogButton_OnClick}"
                                    Text="Test Content Dialog"
                                    ToolTipService.ToolTip="Test Content Dialog">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE8FF;" />
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                <MenuFlyoutItem
                                    Click="{x:Bind TestNotificationButton_OnClick}"
                                    Text="Test Notification"
                                    ToolTipService.ToolTip="Test Notification">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE7E7;" />
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                <MenuFlyoutItem
                                    Click="{x:Bind ThrowExceptionButton_OnClick}"
                                    Text="Throw Exception"
                                    ToolTipService.ToolTip="Throw Exception">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE783;" />
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                <MenuFlyoutItem
                                    Click="{x:Bind TestSentryLoggingButton_OnClick}"
                                    Text="Test Sentry Logging"
                                    ToolTipService.ToolTip="Test Sentry Logging">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE783;" />
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                <MenuFlyoutItem
                                    Click="{x:Bind RestartAppButton_OnClick}"
                                    Text="Restart App"
                                    ToolTipService.ToolTip="Restart App">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xF83E;" />
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                                <MenuFlyoutItem
                                    Click="{x:Bind HideNowPlayingBarButton_OnClick}"
                                    Text="Hide Now Playing Bar"
                                    ToolTipService.ToolTip="Hide Now Playing Bar">
                                    <MenuFlyoutItem.Icon>
                                        <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xE71A;" />
                                    </MenuFlyoutItem.Icon>
                                </MenuFlyoutItem>
                            </MenuFlyout>
                        </AppBarButton.Flyout>
                        <FontIcon FontFamily="Segoe MDL2 Assets" Glyph="&#xEBE8;" />
                    </AppBarButton>
                    <!--  endregion: debug menu  -->
                </CommandBar>
            </StackPanel>
        </StackPanel>

        <!--  library card view  -->
        <ScrollViewer
            x:Name="LibraryCardScrollView"
            Padding="0,8,0,8"
            IsVerticalScrollChainingEnabled="False"
            RelativePanel.AlignBottomWithPanel="True"
            RelativePanel.AlignLeftWithPanel="True"
            RelativePanel.AlignRightWithPanel="True"
            RelativePanel.Below="TitleAndCommandBarPanel">
            <ItemsRepeater
                x:Name="LibraryCardView"
                ItemTemplate="{StaticResource AudiobookTemplate}"
                ItemsSource="{x:Bind ViewModel.Audiobooks, Mode=OneWay}">

                <ItemsRepeater.Layout>
                    <UniformGridLayout
                        ItemsJustification="Start"
                        ItemsStretch="Uniform"
                        MinColumnSpacing="4"
                        MinRowSpacing="12" />
                </ItemsRepeater.Layout>

            </ItemsRepeater>
        </ScrollViewer>

        <!--  progress bar for when library view is loading  -->
        <userControls:ProgressBarCard
            Margin="25,0,50,0"
            Canvas.ZIndex="10"
            IsIndeterminate="True"
            RelativePanel.AlignHorizontalCenterWithPanel="True"
            RelativePanel.AlignLeftWithPanel="True"
            RelativePanel.AlignRightWithPanel="True"
            RelativePanel.AlignVerticalCenterWithPanel="True"
            Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay}" />

        <VisualStateManager.VisualStateGroups>
            <VisualStateGroup x:Name="LibraryCardViewVisibility">
                <!--  when no audiobooks have been imported yet  -->
                <VisualState x:Name="NoAudiobooksState">
                    <VisualState.StateTriggers>
                        <winUi:IsEqualStateTrigger Value="{x:Bind ViewModel.IsLoading, Mode=OneWay}" To="true" />
                        <winUi:IsNullOrEmptyStateTrigger Value="{x:Bind ViewModel.Audiobooks, Mode=OneWay}" />
                    </VisualState.StateTriggers>
                    <VisualState.Setters>
                        <Setter Target="LibraryCardScrollView.Visibility" Value="Collapsed" />
                    </VisualState.Setters>
                </VisualState>
            </VisualStateGroup>
        </VisualStateManager.VisualStateGroups>
    </RelativePanel>
</Page>